<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Saldo banco CAIXA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 12px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #121214;
        color: #f5f5f5;
      }
      body.mode-pc .wrapper {
        max-width: 380px;
        margin: 0 auto;
      }
      body.mode-cel {
        font-size: 15px;
      }
      body.mode-cel .wrapper {
        gap: 18px;
      }

      .wrapper {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* CART√ÉO SALDO */
      .card-saldo {
        background: linear-gradient(135deg, #8a05be, #6511c5);
        border-radius: 16px;
        padding: 14px 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      }
      body.mode-cel .card-saldo {
        padding: 18px 18px;
        border-radius: 18px;
      }
      .card-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .card-label {
        font-size: 12px;
        opacity: 0.85;
      }
      body.mode-cel .card-label {
        font-size: 13px;
      }
      .eye-btn {
        background: transparent;
        border: none;
        color: #f5f5f5;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
      }
      .saldo-linha {
        display: flex;
        align-items: baseline;
        gap: 4px;
        margin-bottom: 6px;
      }
      .saldo-prefix {
        font-size: 14px;
        opacity: 0.9;
      }
      .saldo-valor {
        font-size: 24px;
        font-weight: 600;
      }
      body.mode-cel .saldo-valor {
        font-size: 30px;
      }
      .card-bottom {
        font-size: 11px;
        opacity: 0.9;
      }
      body.mode-cel .card-bottom {
        font-size: 12px;
      }
      .card-bottom span {
        display: block;
      }
      #versaoLabel {
        margin-top: 4px;
        font-size: 11px;
        opacity: 0.9;
      }
      body.mode-cel #versaoLabel {
        font-size: 12px;
      }

      /* FORMUL√ÅRIO */
      .form-box {
        background: #1b1b1f;
        border-radius: 14px;
        padding: 12px 14px;
      }
      body.mode-cel .form-box {
        padding: 16px 18px;
        border-radius: 18px;
      }
      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
      }
      .tab {
        flex: 1;
        padding: 6px 0;
        border-radius: 999px;
        border: 1px solid #3b3b4a;
        background: #18181c;
        color: #e5e5e5;
        font-size: 12px;
        cursor: pointer;
      }
      .tab.active {
        background: #8a05be;
        border-color: #8a05be;
      }
      body.mode-cel .tab {
        padding: 8px 0;
        font-size: 13px;
      }
      label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
      }
      body.mode-cel label {
        font-size: 13px;
      }
      input[type="date"],
      input[type="number"] {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #2b2b35;
        background: #15151a;
        color: #f5f5f5;
        font-size: 12px;
        margin-top: 2px;
      }
      body.mode-cel input[type="date"],
      body.mode-cel input[type="number"] {
        padding: 10px 12px;
        font-size: 14px;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .primary-btn {
        width: 100%;
        margin-top: 12px;
        padding: 8px 0;
        border-radius: 999px;
        border: none;
        background: #8a05be;
        color: #fdfdfd;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }
      .primary-btn:hover {
        filter: brightness(1.07);
      }
      body.mode-cel .primary-btn {
        padding: 12px 0;
        font-size: 15px;
      }
      #status {
        margin-top: 8px;
        font-size: 11px;
        min-height: 14px;
      }
      body.mode-cel #status {
        font-size: 12px;
      }

      /* HIST√ìRICO */
      .historico {
        background: #1b1b1f;
        border-radius: 14px;
        padding: 10px 14px;
      }
      body.mode-cel .historico {
        padding: 14px 18px;
        border-radius: 18px;
      }
      .historico-title {
        font-size: 12px;
        margin-bottom: 6px;
        opacity: 0.9;
      }
      body.mode-cel .historico-title {
        font-size: 13px;
      }
      .lista {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 180px;
        overflow-y: auto;
      }
      body.mode-cel .lista {
        max-height: 240px;
      }
      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #252533;
        font-size: 11px;
      }
      .item:last-child {
        border-bottom: none;
      }
      .item-info {
        display: flex;
        flex-direction: column;
      }
      .item-tipo {
        font-weight: 500;
      }
      .item-data {
        opacity: 0.8;
      }
      .item-valor {
        font-weight: 500;
      }
      .item-empty {
        font-size: 11px;
        opacity: 0.7;
        padding: 4px 0;
      }

      /* OVERLAYS */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .hidden {
        display: none !important;
      }
      .modal-card {
        background: #1b1b20;
        border-radius: 16px;
        padding: 14px 16px;
        max-width: 300px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        font-size: 13px;
      }
      body.mode-cel .modal-card {
        max-width: 340px;
      }
      .modal-title {
        font-size: 15px;
        margin-bottom: 8px;
      }
      .modal-text {
        font-size: 12px;
        margin-bottom: 10px;
        opacity: 0.9;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }
      .btn-chip {
        flex: 1;
        padding: 6px 0;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 12px;
      }
      .btn-chip.pc {
        background: #2d2d3a;
        color: #ffffff;
      }
      .btn-chip.cel {
        background: #8a05be;
        color: #ffffff;
      }
      body.mode-cel .btn-chip {
        padding: 8px 0;
        font-size: 13px;
      }

      .preview-msg {
        background: #14141a;
        border-radius: 8px;
        padding: 8px;
        font-size: 11px;
        max-height: 100px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .preview-label {
        font-size: 12px;
        margin-bottom: 4px;
      }
      .preview-saldo {
        margin-top: 8px;
        font-size: 12px;
      }
      .preview-actions button {
        padding: 6px 10px;
        border-radius: 999px;
        border: none;
        font-size: 12px;
        cursor: pointer;
      }
      .preview-cancel {
        background: #2d2d3a;
        color: #f5f5f5;
      }
      .preview-confirm {
        background: #04d361;
        color: #0b0b10;
      }
      body.mode-cel .preview-msg {
        max-height: 140px;
        font-size: 12px;
      }
      body.mode-cel .preview-actions button {
        padding: 8px 12px;
        font-size: 13px;
      }
    </style>
  </head>
  <body class="mode-pc">
    <div class="wrapper">
      <!-- CART√ÉO DE SALDO -->
      <div class="card-saldo">
        <div class="card-top">
          <span class="card-label">Saldo Mercado Pago</span>
          <button class="eye-btn" type="button" onclick="toggleSaldo()" title="Mostrar/ocultar saldo">
            üëÅÔ∏è
          </button>
        </div>
        <div class="saldo-linha">
          <span class="saldo-prefix" id="saldoPrefix">R$</span>
          <span class="saldo-valor" id="saldoValor" data-real="0,00" data-oculto="false">0,00</span>
        </div>
        <div class="card-bottom">
          <span>Total depositado: <strong id="totalDep">R$ 0,00</strong></span>
          <span>Total retirado: <strong id="totalRet">R$ 0,00</strong></span>
          <span id="versaoLabel">Modo: -</span>
        </div>
      </div>

      <!-- FORMUL√ÅRIO -->
      <div class="form-box">
        <div class="tabs">
          <button type="button" class="tab active" onclick="setTipo(this, 'deposito')">
            Dep√≥sito
          </button>
          <button type="button" class="tab" onclick="setTipo(this, 'retirada')">
            Retirada
          </button>
        </div>

        <label>
          Data
          <input type="date" id="data" />
        </label>

        <label>
          Valor (R$)
          <input type="number" id="valor" step="0.01" min="0" />
        </label>

        <button class="primary-btn" type="button" onclick="enviar()">
          Salvar e preparar WhatsApp
        </button>

        <div id="status"></div>
      </div>

      <!-- HIST√ìRICO -->
      <div class="historico">
        <div class="historico-title">√öltimas transa√ß√µes</div>
        <ul class="lista" id="listaTransacoes">
          <li class="item-empty">Nenhuma transa√ß√£o ainda.</li>
        </ul>
      </div>
    </div>

    <!-- POPUP VERS√ÉO PC / CELULAR -->
    <div id="versaoOverlay" class="overlay">
      <div class="modal-card">
        <div class="modal-title">Como voc√™ est√° usando?</div>
        <div class="modal-text">
          Escolha se est√° usando este painel no <strong>PC</strong> ou no <strong>celular</strong>.
        </div>
        <div class="modal-actions">
          <button class="btn-chip pc" type="button" onclick="escolherVersao('pc')">PC</button>
          <button class="btn-chip cel" type="button" onclick="escolherVersao('cel')">Celular</button>
        </div>
      </div>
    </div>

    <!-- POPUP PREVIEW WHATSAPP -->
    <div id="previewOverlay" class="overlay hidden">
      <div class="modal-card">
        <div class="modal-title">Pr√©via da mensagem</div>
        <div class="preview-label">Mensagem que ser√° enviada no WhatsApp:</div>
        <div class="preview-msg" id="previewMsg"></div>
        <p class="preview-saldo">
          Saldo ap√≥s esta opera√ß√£o: <strong id="previewSaldo"></strong>
        </p>
        <div class="modal-actions preview-actions">
          <button type="button" class="preview-cancel" onclick="fecharPreview()">Cancelar</button>
          <button type="button" class="preview-confirm" onclick="confirmarEnvio()">Enviar agora</button>
        </div>
      </div>
    </div>

    <script>
      // URL do teu Web App (j√° com o link que voc√™ mandou)
      const SCRIPT_URL =
        'https://script.google.com/macros/s/AKfycbyISW-slkYDpZ09fmUPQA5HCfF6fDopBJcFMH-aKAIYpwMYi5VgUUHhwwPOijC4lwom4A/exec';

      let tipoSelecionado = 'deposito';
      let versaoSelecionada = null;
      let ultimaUrlWhatsapp = null;
      let ultimaMensagem = null;
      let ultimoSaldoPos = null;

      function setTipo(btn, tipo) {
        tipoSelecionado = tipo;
        document.querySelectorAll('.tab').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
      }

      function toggleSaldo() {
        const valorEl = document.getElementById('saldoValor');
        const prefixEl = document.getElementById('saldoPrefix');
        const oculto = valorEl.getAttribute('data-oculto') === 'true';

        if (oculto) {
          const real = valorEl.getAttribute('data-real') || '0,00';
          valorEl.textContent = real;
          valorEl.setAttribute('data-oculto', 'false');
          prefixEl.textContent = 'R$';
        } else {
          const real = valorEl.textContent;
          valorEl.setAttribute('data-real', real);
          valorEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
          valorEl.setAttribute('data-oculto', 'true');
          prefixEl.textContent = '';
        }
      }

      function atualizarDashboard(info) {
        if (!info) return;

        const saldo = info.saldo || 'R$ 0,00';
        const totalRet = info.totalRet || 'R$ 0,00';
        const totalDep = info.totalDep || 'R$ 0,00';

        const partes = saldo.split(' ');
        const prefix = partes[0] || 'R$';
        const valor = partes[1] || '0,00';

        const saldoValorEl = document.getElementById('saldoValor');
        document.getElementById('saldoPrefix').textContent = prefix;
        saldoValorEl.textContent = valor;
        saldoValorEl.setAttribute('data-real', valor);
        saldoValorEl.setAttribute('data-oculto', 'false');

        document.getElementById('totalRet').textContent = totalRet;
        document.getElementById('totalDep').textContent = totalDep;

        const lista = document.getElementById('listaTransacoes');
        lista.innerHTML = '';
        if (info.transacoes && info.transacoes.length) {
          info.transacoes.forEach((t) => {
            const li = document.createElement('li');
            li.className = 'item';
            li.innerHTML =
              '<div class="item-info">' +
              '<span class="item-tipo">' +
              t.tipo +
              '</span>' +
              '<span class="item-data">' +
              (t.data || '') +
              '</span>' +
              '</div>' +
              '<div class="item-valor">' +
              t.valor +
              '</div>';
            lista.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.className = 'item-empty';
          li.textContent = 'Nenhuma transa√ß√£o ainda.';
          lista.appendChild(li);
        }
      }

      async function carregarDashboard() {
        try {
          const res = await fetch(SCRIPT_URL + '?action=dashboard');
          const info = await res.json();
          atualizarDashboard(info);
        } catch (err) {
          console.error('Erro ao carregar dashboard', err);
          const status = document.getElementById('status');
          if (status) {
            status.textContent = 'Erro ao carregar saldo.';
            status.style.color = '#ffb3b3';
          }
        }
      }

      async function enviar() {
        const data = document.getElementById('data').value;
        const valor = document.getElementById('valor').value;
        const status = document.getElementById('status');

        if (!data || !valor) {
          status.textContent = 'Preencha data e valor.';
          status.style.color = '#ffb3b3';
          return;
        }

        status.textContent = 'Salvando lan√ßamento...';
        status.style.color = '#cccccc';

        const params = new URLSearchParams({
          action: 'registrar',
          tipo: tipoSelecionado,
          data: data,
          valor: valor,
        });

        try {
          const res = await fetch(SCRIPT_URL + '?' + params.toString());
          const json = await res.json();

          if (json.dashboard) {
            atualizarDashboard(json.dashboard);
            ultimoSaldoPos = json.dashboard.saldo;
          }

          ultimaUrlWhatsapp = json.url;
          ultimaMensagem = json.mensagem;
          mostrarPreview();

          status.textContent = 'Lan√ßamento salvo. Confira a mensagem antes de enviar.';
          status.style.color = '#a6ffcb';
          document.getElementById('valor').value = '';
        } catch (err) {
          console.error('Erro ao registrar', err);
          status.textContent = 'Erro ao salvar lan√ßamento.';
          status.style.color = '#ffb3b3';
        }
      }

      function mostrarPreview() {
        if (!ultimaMensagem) return;
        document.getElementById('previewMsg').textContent = ultimaMensagem;
        document.getElementById('previewSaldo').textContent = ultimoSaldoPos || '';
        document.getElementById('previewOverlay').classList.remove('hidden');
      }

      function fecharPreview() {
        document.getElementById('previewOverlay').classList.add('hidden');
      }

      function confirmarEnvio() {
        if (ultimaUrlWhatsapp) {
          window.open(ultimaUrlWhatsapp, '_blank');
        }
        fecharPreview();
      }

      function aplicarModoVersao() {
        const body = document.body;
        body.classList.remove('mode-pc', 'mode-cel');
        if (versaoSelecionada === 'pc') {
          body.classList.add('mode-pc');
        } else if (versaoSelecionada === 'cel') {
          body.classList.add('mode-cel');
        } else {
          body.classList.add('mode-pc');
        }

        const el = document.getElementById('versaoLabel');
        if (!versaoSelecionada) {
          el.textContent = 'Modo: -';
        } else if (versaoSelecionada === 'pc') {
          el.textContent = 'Modo: PC';
        } else {
          el.textContent = 'Modo: Celular';
        }
      }

      function escolherVersao(tipo) {
        versaoSelecionada = tipo;
        aplicarModoVersao();
        document.getElementById('versaoOverlay').classList.add('hidden');
      }

      function setDataHoje() {
        const input = document.getElementById('data');
        if (!input) return;
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        input.value = `${ano}-${mes}-${dia}`;
      }

      function init() {
        setDataHoje();
        aplicarModoVersao();
        carregarDashboard();
      }

      init();
    </script>
  </body>
</html>

